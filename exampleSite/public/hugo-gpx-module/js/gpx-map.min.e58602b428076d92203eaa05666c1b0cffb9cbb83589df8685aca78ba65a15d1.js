(function(e){"use strict";class t{constructor(e,t,n,s){this.mapId=e,this.statsId=t,this.gpxFiles=n,this.config=s,this.map=null,this.routeLayers=new Map,this.markerLayers=new Map,this.routeData=new Map,this.routeStats=new Map,this.colorIndex=0,this.colors=s.colors&&Array.isArray(s.colors)&&s.colors.length>0?s.colors:["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6"],this.focusMarker=null,this.isElevationVisible=this.config.ele.active}async init(){if(typeof L=="undefined"){setTimeout(()=>this.init(),50);return}try{await this.initMap(),await this.loadGPXFiles()}catch(e){console.error("GPX Init Error:",e)}}async initMap(){return new Promise((e,t)=>{const i=document.getElementById(this.mapId);if(!i)return t("Map element missing");this.map=L.map(this.mapId,{zoomControl:!1,attributionControl:!0,preferCanvas:!0,zoomAnimation:!0,markerZoomAnimation:!0,fadeAnimation:!0,inertia:!0});const n=L.tileLayer(this.config.tiles.osm.url,{maxZoom:19,attribution:this.config.tiles.osm.attr}),s=L.tileLayer(this.config.tiles.topo.url,{maxZoom:17,attribution:this.config.tiles.topo.attr}),o=L.tileLayer(this.config.tiles.sat.url,{attribution:this.config.tiles.sat.attr}),a={Standard:n,Topographic:s,Satellite:o};this.config.defaultLayer==="satellite"?o.addTo(this.map):this.config.defaultLayer==="topo"?s.addTo(this.map):n.addTo(this.map),L.control.layers(a,null,{position:"topright"}).addTo(this.map),this.map.setView([this.config.view.lat,this.config.view.lon],this.config.view.zoom),this.setupResizeHandling(),e()})}_getDistance(e,t,n,s){const i=6371e3,a=e*Math.PI/180,r=n*Math.PI/180,c=(n-e)*Math.PI/180,l=(s-t)*Math.PI/180,o=Math.sin(c/2)**2+Math.cos(a)*Math.cos(r)*Math.sin(l/2)**2;return i*2*Math.atan2(o**.5,(1-o)**.5)}async loadGPXFiles(){for(let e=0;e<this.gpxFiles.length;e++)try{await this.loadSingleGPX(this.gpxFiles[e],e)}catch(t){console.warn("Load failed: "+this.gpxFiles[e],t)}const e=document.querySelector(`#${this.mapId} .gpx-loading`);e&&(e.style.display="none"),this.createRouteSelector(),this.fitToRoutes(),this.config.showStats&&this.calculateAndShowTotalStats(),this.updateElevationButton(),this.isElevationVisible&&this._drawElevationProfile()}async loadSingleGPX(e,t){const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const m=await a.text(),h=new DOMParser,r=h.parseFromString(m,"text/xml"),c=e=>Array.from(e).map(e=>{const n=parseFloat(e.querySelector("ele")?.textContent||"0"),t=e.querySelector("time");return{lat:parseFloat(e.getAttribute("lat")),lon:parseFloat(e.getAttribute("lon")),ele:n,time:t?new Date(t.textContent).getTime():null}}).filter(e=>!isNaN(e.lat)),i=Array.from(r.querySelectorAll("trk")).map(e=>{const n=e.querySelector("name")?.textContent||`Track ${t+1}`,s=Array.from(e.querySelectorAll("trkseg")).map(e=>c(e.querySelectorAll("trkpt"))).filter(e=>e.length>0);return{name:n,segments:s}}).filter(e=>e.segments.length>0),o=Array.from(r.querySelectorAll("rte")).map(e=>{const n=e.querySelector("name")?.textContent||`Route ${t+1}`;return{name:n,points:c(e.querySelectorAll("rtept"))}}).filter(e=>e.points.length>0);if(!i.length&&!o.length)return;const n={type:"FeatureCollection",features:[]},l=(e,t)=>e.forEach(e=>{const s=t?e.points:e.segments.flat(),o=t?s.map(e=>[e.lon,e.lat,e.ele,e.time]):e.segments.map(e=>e.map(e=>[e.lon,e.lat,e.ele,e.time])),i=t?"LineString":"MultiLineString";n.features.push({type:"Feature",properties:{name:e.name},geometry:{type:i,coordinates:o}})});l(i,!1),l(o,!0);const s=this.calculateRouteStats(n);this.routeStats.set(t,s);const d=this.colors[this.colorIndex%this.colors.length];this.colorIndex++,this.routeData.set(t,{geojson:n,color:d,originalFile:e,name:this.getFileName(e)});const u=L.geoJSON(n,{style:{color:d,weight:this.config.style.weight,opacity:this.config.style.opacity,lineCap:"round",lineJoin:"round"},smoothFactor:1}).addTo(this.map);this.routeLayers.set(t,u),this.config.showMarkers&&this.addStartEndMarkers(t,n);const f=i[0]?.name||o[0]?.name||this.getFileName(e);u.bindPopup(`
            <div class="gpx-popup-content">
                <span class="gpx-popup-title">${f}</span>
                <span class="gpx-popup-stat">üìè Dist: <b>${s.distance.toFixed(1)} km</b></span>
                <span class="gpx-popup-stat">üèîÔ∏è Elev: <span style="color:#28a745">‚Üó ${s.elevationGain}m</span> <span style="color:#dc3545">‚Üò ${s.elevationLoss}m</span></span>
            </div>
        `)}addStartEndMarkers(e,t){const n=L.layerGroup();t.features.forEach(e=>{const s=e.geometry.coordinates,t=e.geometry.type==="MultiLineString"?s.flat():s;if(t.length>0){const e=t[0],s=t[t.length-1];L.marker([e[1],e[0]],{icon:L.divIcon({className:"gpx-marker-start",html:"",iconSize:[12,12]}),interactive:!1}).addTo(n),L.marker([s[1],s[0]],{icon:L.divIcon({className:"gpx-marker-end",html:"",iconSize:[12,12]}),interactive:!1}).addTo(n)}}),n.addTo(this.map),this.markerLayers.set(e,n)}calculateRouteStats(e){let o=0,i=0,a=0,s=-(1/0),t=null,n=null;const r=5;return e.features.forEach(e=>{const c=e.geometry.type==="MultiLineString"?e.geometry.coordinates.flat():e.geometry.coordinates;if(!c.length)return;const l=c[0][3],d=c[c.length-1][3];l&&(!t||l<t)&&(t=l),d&&(!n||d>n)&&(n=d);let u=c[0][2]||0;for(let e=1;e<c.length;e++){const[l,d]=c[e-1],[h,m,f]=c[e];o+=this._getDistance(d,l,m,h);const n=f||0,t=n-u;(t<0?-t:t)>=r&&(t>0?i+=t:a+=Math.abs(t),u=n),s=Math.max(s,n)}}),{distance:o/1e3,elevationGain:Math.round(i),elevationLoss:Math.round(a),highestPoint:Math.round(s===-(1/0)?0:s),duration:t&&n?n-t:0}}_prepareElevationData(){let e=[],t=0;const n=Array.from(this.routeData.keys()).sort((e,t)=>e-t);return n.forEach(n=>{const s=this.routeLayers.get(n);if(!this.map.hasLayer(s))return;const o=this.routeData.get(n).geojson;o.features.forEach(n=>{const s=n.geometry.type==="MultiLineString"?n.geometry.coordinates.flat():n.geometry.coordinates;for(let n=0;n<s.length;n++){const[o,i,a]=s[n];if(n>0){const[e,a]=s[n-1];t+=this._getDistance(a,e,i,o)}e.push({dist:t/1e3,ele:a||0,lat:i,lon:o})}})}),e}toggleElevation(){this.isElevationVisible=!this.isElevationVisible,this.updateElevationButton(),this.isElevationVisible?this._drawElevationProfile():(document.getElementById(`${this.mapId}-elevation`).style.display="none",this.focusMarker&&this.focusMarker.remove())}updateElevationButton(){const e=document.getElementById(`${this.mapId}-btn-ele`);e&&(e.style.backgroundColor=this.isElevationVisible?"#5a6268":"#6c757d",e.style.boxShadow=this.isElevationVisible?"inset 0 2px 4px rgba(0,0,0,0.2)":"none")}_drawElevationProfile(){const d=`${this.mapId}-elevation`,a=document.getElementById(d),i=document.getElementById(`${this.mapId}-ele-tooltip`);if(!this.isElevationVisible){a.style.display="none";return}const n=this._prepareElevationData();if(n.length===0){a.style.display="none",this.focusMarker&&this.focusMarker.remove();return}a.style.display="block",d3.select("#"+d).selectAll("svg").remove();const e={top:10,right:5,bottom:20,left:35},r=a.clientWidth-e.left-e.right,s=a.clientHeight-e.top-e.bottom,m=this.config.ele.color,o=d3.select("#"+d).append("svg").attr("width",r+e.left+e.right).attr("height",s+e.top+e.bottom).append("g").attr("transform",`translate(${e.left},${e.top})`),t=d3.scaleLinear().domain(d3.extent(n,e=>e.dist)).range([0,r]),c=d3.extent(n,e=>e.ele),f=(c[1]-c[0])*.1,l=d3.scaleLinear().domain([c[0]-f,c[1]+f]).range([s,0]);o.append("path").datum(n).attr("fill",m).attr("fill-opacity",.2).attr("stroke",m).attr("stroke-width",2).attr("d",d3.area().x(e=>t(e.dist)).y0(s).y1(e=>l(e.ele))),o.append("g").attr("transform",`translate(0,${s})`).call(d3.axisBottom(t).ticks(5).tickFormat(e=>e+" km")),o.append("g").call(d3.axisLeft(l).ticks(5));const u=o.append("circle").attr("class","elevation-focus-circle").attr("r",5).attr("fill",this.config.markerEndColor).style("opacity",0),h=o.append("line").attr("class","elevation-focus-line").style("opacity",0).attr("y1",0).attr("y2",s);this.focusMarker||(this.focusMarker=L.circleMarker([0,0],{radius:6,color:this.config.markerEndColor,fillColor:this.config.markerEndColor,fillOpacity:1})),o.append("rect").attr("width",r).attr("height",s).style("fill","none").style("pointer-events","all").on("mouseover",()=>{u.style("opacity",1),h.style("opacity",1),i.style.display="block",this.focusMarker.addTo(this.map)}).on("mouseout",()=>{u.style("opacity",0),h.style("opacity",0),i.style.display="none",this.focusMarker.remove()}).on("mousemove",e=>{const c=t.invert(d3.pointer(e)[0]),d=d3.bisector(e=>e.dist).left,a=d(n,c,1),s=n[a]||n[a-1];if(!s)return;u.attr("cx",t(s.dist)).attr("cy",l(s.ele)),h.attr("x1",t(s.dist)).attr("x2",t(s.dist));let o=t(s.dist)+10;o+80>r&&(o=t(s.dist)-90),i.innerHTML=`<strong style="color:#000!important;font-weight:bold;">${s.dist.toFixed(1)} km</strong><br><span style="color:#000!important;">${Math.round(s.ele)} m</span>`,i.style.left=o+"px",i.style.top=l(s.ele)-30+"px",this.focusMarker.setLatLng([s.lat,s.lon])})}formatTime(e){if(!e||e<=0)return"--:--";const t=Math.floor(e/6e4);return`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}h`}createRouteSelector(){const e=document.getElementById(this.mapId+"-routes"),t=document.getElementById(this.mapId+"-route-selector");if(!e)return;this.routeData.size>0&&t&&(t.style.display="block"),e.innerHTML="";const n=Array.from(this.routeData.keys()).sort((e,t)=>e-t);n.forEach(t=>{const o=this.routeData.get(t),s=this.routeStats.get(t),i=this.map.hasLayer(this.routeLayers.get(t)),n=document.createElement("div");n.className="gpx-item-style",n.style.cssText=`display:flex;align-items:center;padding:0.5rem;border-radius:4px;border-left:5px solid ${i?o.color:"#ccc"}; transition: background 0.2s;`,n.onmouseenter=()=>this.highlightRoute(t,!0),n.onmouseleave=()=>this.highlightRoute(t,!1);const a=s.duration?`<span class="route-stat-pill gpx-text-muted" title="Duration">‚è± ${this.formatTime(s.duration)}</span>`:"";n.innerHTML=`
            <input type="checkbox" ${i?"checked":""} onchange="window.gpxMaps['${this.mapId}'].toggleRoute(${t})" style="margin-right:10px; cursor:pointer;">
            <div style="flex:1;overflow:hidden;margin-right:10px;">
                <div style="font-weight:600;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#333 !important;" title="${o.name}">${o.name}</div>
                <div class="route-details">
                    <span class="route-stat-pill gpx-text-muted">üìè ${s.distance.toFixed(1)} km</span>
                    <span class="route-stat-pill" style="color:#28a745 !important">‚Üó ${s.elevationGain}m</span>
                    <span class="route-stat-pill" style="color:#dc3545 !important">‚Üò ${s.elevationLoss}m</span>
                    ${a}
                </div>
            </div>
            <button onclick="window.gpxMaps['${this.mapId}'].downloadGPX(${t})" title="Download GPX" style="background:transparent;color:#007bff;border:1px solid #cce5ff;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:1.1rem;">üì•</button>
          `,e.appendChild(n)})}highlightRoute(e,t){const n=this.routeLayers.get(e);n&&this.map.hasLayer(n)&&(n.setStyle({weight:t?this.config.style.weight+3:this.config.style.weight,opacity:t?1:this.config.style.opacity}),t&&n.bringToFront())}toggleRoute(e){const t=this.routeLayers.get(e),n=this.markerLayers.get(e);if(!t)return;this.map.hasLayer(t)?(this.map.removeLayer(t),n&&this.map.removeLayer(n)):(this.map.addLayer(t),n&&this.map.addLayer(n)),this.updateAllComponents()}showAllRoutes(){this.batchUpdateRoutes(!0)}hideAllRoutes(){this.batchUpdateRoutes(!1)}batchUpdateRoutes(e){this.routeLayers.forEach((t,n)=>{const s=this.markerLayers.get(n);e&&!this.map.hasLayer(t)&&(this.map.addLayer(t),s&&this.map.addLayer(s)),!e&&this.map.hasLayer(t)&&(this.map.removeLayer(t),s&&this.map.removeLayer(s))}),this.updateAllComponents(),e&&this.fitToRoutes()}updateAllComponents(){this.createRouteSelector(),this.config.showStats&&this.calculateAndShowTotalStats(),this._drawElevationProfile()}fitToRoutes(){const e=[];this.routeLayers.forEach(t=>{this.map.hasLayer(t)&&e.push(t)}),e.length&&this.map.flyToBounds(L.featureGroup(e).getBounds(),{padding:[20,20],duration:1.5})}calculateAndShowTotalStats(){const e=document.getElementById(this.statsId);if(!e)return;let n=0,s=0,o=0,t=0,i=0;this.routeLayers.forEach((e,a)=>{if(this.map.hasLayer(e)){t++;const e=this.routeStats.get(a);n+=e.distance,s+=e.elevationGain,o+=e.elevationLoss,i+=e.duration}}),e.querySelector('[data-stat="distance"]').textContent=n.toFixed(2),e.querySelector('[data-stat="elevation"]').innerHTML=`
          <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; line-height:1.2;">
             <span style="color:#28a745 !important">‚Üó ${s}m</span>
             <span style="color:#dc3545 !important">‚Üò ${o}m</span>
          </div>
        `,e.querySelector('[data-stat="time"]').textContent=this.formatTime(i),e.querySelector('[data-stat="routeCount"]').textContent=t,e.style.display=t>0?"block":"none"}getFileName(e){return e.split("/").pop().replace(".gpx","").replace(/[-_]/g," ")}downloadGPX(e){const t=this.routeData.get(e)?.originalFile;if(!t)return;fetch(t).then(e=>e.text()).then(e=>{const n=document.createElement("a");n.href=URL.createObjectURL(new Blob([e],{type:"application/gpx+xml"})),n.download=t.split("/").pop(),n.click()})}setupResizeHandling(){const t=document.getElementById(this.mapId),e=()=>{this.map&&this.map.invalidateSize(),this._drawElevationProfile()};window.addEventListener("resize",e),t&&typeof ResizeObserver!="undefined"&&new ResizeObserver(e).observe(t),setTimeout(e,500)}fitToVisibleRoutes(){this.fitToRoutes()}}e.GPXMapHandler=t})(window)